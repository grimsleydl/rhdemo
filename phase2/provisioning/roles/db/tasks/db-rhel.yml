---
- name: set selinux permissive
  selinux:
    policy: targeted
    state: permissive

- name: set up hosts file
  blockinfile:
    path: /etc/hosts
    block: |
      192.168.150.31 db-1
      192.168.150.32 db-2

- name: Enable HA repo
  command: yum-config-manager --enable ha

- name: Enable resilient-storage repo
  command: yum-config-manager --enable resilient-storage

- name: Install pcs packages
  yum:
    name: "{{ item }}"
    state: latest
  loop: "{{cluster_packages | flatten(levels=1)}}"
  tags: packages

- name: enable lvmlockd
  replace:
    path: /etc/lvm/lvm.conf
    regexp: 'use_lvmlockd = 0'
    replace: 'use_lvmlockd = 1'

- name: Perform a discovery on 192.168.140.1 and show available target nodes
  open_iscsi:
    show_nodes: yes
    discover: yes
    ip: 192.168.140.1
    login: yes

- name: Connect to the target
  open_iscsi:
    login: yes
    target: iqn.2022-03.com.example:db
    auto_node_startup: yes

- name: Fix iscsi on boot
  copy:
    src: "../files/etc/systemd/system/iscsi-boot.service"
    dest: "/etc/systemd/system/iscsi-boot.service"
    mode: 0755

- name: Enable iscsi service
  service:
    name: iscsi
    state: started
    enabled: yes

- name: ensure /san/mysql-fs exists
  file:
    path: /san/mysql-fs
    state: directory

- name: disable firewalld service
  service:
    name: firewalld
    state: stopped
    enabled: no

- name: enable iptables service
  service:
    name: iptables
    state: started
    enabled: yes

- name: Allow cluster traffic
  ansible.builtin.iptables:
    chain: INPUT
    in_interface: eth3
    jump: ACCEPT

- name: Allow cluster traffic
  ansible.builtin.iptables:
    chain: INPUT
    in_interface: eth4
    jump: ACCEPT
